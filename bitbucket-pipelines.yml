image: node:14.17.1

pipelines:
  default:
    - step:
        name: Build and test
        script:
          - source <(curl -L https://dot.net/v1/dotnet-install.sh) -c 5.0
          - yarn install --frozen-lockfile
          - yarn lerna run build
          - yarn test
        caches:
          - node

  tags:
    v*:
      - step:
          name: Build and test
          script:
            - source <(curl -L https://dot.net/v1/dotnet-install.sh) -c 5.0
            - yarn install --frozen-lockfile
            - yarn lerna run build
            - yarn test
          artifacts:
            - packages/*/lib/**
            - packages/Linters/*/lib/**
            - packages/Build/*/lib/**
          caches:
            - node
      - step:
          name: Publish
          trigger: manual
          deployment: production
          script:
            - npm config set //f.feedz.io/leancode/corelibrary/npm/:_authToken ${NPM_TOKEN}
            - yarn install --frozen-lockfile
            - yarn lerna publish from-git --yes
          caches:
            - node
